# ComfyUI Prompt Skills - Makefile
# ä¸‰å±‚è§£è€¦æ¶æ„æ„å»ºä¸æµ‹è¯•

.PHONY: help install install-dev build build-vue test lint clean all standalone debug

# é»˜è®¤ç›®æ ‡
help:
	@echo "ComfyUI Prompt Skills - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  make install          - å®‰è£… Python ä¾èµ–"
	@echo "  make install-dev      - å®‰è£…å¼€å‘ä¾èµ– (åŒ…å«æµ‹è¯•)"
	@echo "  make build            - æ„å»ºæ‰€æœ‰ (Python + Vue)"
	@echo "  make build-vue        - ä»…æ„å»º Vue å‰ç«¯"
	@echo "  make package          - æ‰“åŒ… Python wheel"
	@echo "  make dist             - åˆ›å»ºå®Œæ•´å‘å¸ƒåŒ…"
	@echo "  make deploy           - éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨"
	@echo "  make test             - è¿è¡Œå•å…ƒæµ‹è¯• (å¿«é€Ÿ)"
	@echo "  make test-integration - è¿è¡Œé›†æˆæµ‹è¯• (å¯åŠ¨ OpenCode Server)"
	@echo "  make test-all         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make standalone       - å¯åŠ¨ç‹¬ç«‹å‰ç«¯æµ‹è¯•æœåŠ¡å™¨"
	@echo "  make debug            - å¯åŠ¨è°ƒè¯•æ¨¡å¼æœåŠ¡å™¨"
	@echo "  make lint             - ä»£ç æ£€æŸ¥"
	@echo "  make clean            - æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  make all              - å®Œæ•´å®‰è£…+æ„å»º+æµ‹è¯•"
	@echo ""


# ============================================
# å®‰è£…
# ============================================

install:
	@echo "ğŸ“¦ Installing Python dependencies..."
	pip install -e .

install-dev:
	@echo "ğŸ“¦ Installing Python dev dependencies..."
	pip install -e ".[dev]"

install-vue:
	@echo "ğŸ“¦ Installing Node.js dependencies..."
	cd web && npm install

# ============================================
# æ„å»º
# ============================================

build: build-vue
	@echo "âœ… Build complete!"

build-vue:
	@echo "ğŸ”¨ Building Vue frontend..."
	cd web && npm run build
	@echo "âœ… Vue build output in js/"

# ============================================
# æ‰“åŒ…ä¸å‘å¸ƒ
# ============================================

package: build
	@echo "ğŸ“¦ Building Python wheel package..."
	pip install build
	python -m build --wheel
	@echo "âœ… Wheel package built in dist/"

dist: package
	@echo "ğŸ“¦ Creating distribution package..."
	rm -rf dist/deploy
	mkdir -p dist/deploy
	cp -r js/ dist/deploy/js/
	cp -r skills/ dist/deploy/skills/
	cp -r data/ dist/deploy/data/
	cp -r backend/ dist/deploy/backend/
	cp -r nodes/ dist/deploy/nodes/
	cp __init__.py dist/deploy/
	cp install.sh dist/deploy/
	cp dist/*.whl dist/deploy/
	cp ../../opencode.json dist/deploy/
	@echo "âœ… Distribution package ready in dist/deploy/"

deploy:
	@echo "ğŸš€ Deploying to remote server..."
	../../sync.sh


# ============================================
# æµ‹è¯•
# ============================================

test:
	@echo "ğŸ§ª Running unit tests..."
	COMFYUI_PROMPT_SKILLS_TESTING=1 PYTHONPATH=. pytest tests/ -v --ignore=tests/test_integration.py

test-integration:
	@echo "ğŸ§ª Running integration tests (requires OpenCode Server)..."
	@echo "   OpenCode Server will be started automatically..."
	COMFYUI_PROMPT_SKILLS_TESTING=1 PYTHONPATH=. pytest tests/test_integration.py -v -s --timeout=60

test-all:
	@echo "ğŸ§ª Running all tests..."
	COMFYUI_PROMPT_SKILLS_TESTING=1 PYTHONPATH=. pytest tests/ -v -s --timeout=60

test-cov:
	@echo "ğŸ§ª Running tests with coverage..."
	COMFYUI_PROMPT_SKILLS_TESTING=1 PYTHONPATH=. pytest tests/ -v --cov=backend --cov-report=term-missing --ignore=tests/test_integration.py

test-quick:
	@echo "ğŸ§ª Running quick tests..."
	COMFYUI_PROMPT_SKILLS_TESTING=1 PYTHONPATH=. pytest tests/ -v -x --tb=short --ignore=tests/test_integration.py

# ============================================
# ä»£ç è´¨é‡
# ============================================

lint:
	@echo "ğŸ” Running linters..."
	-ruff check backend/ nodes/
	-mypy backend/ nodes/ --ignore-missing-imports

format:
	@echo "ğŸ¨ Formatting code..."
	ruff format backend/ nodes/

# ============================================
# æ¸…ç†
# ============================================

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf js/prompt-skills.*.js js/style.css
	rm -rf web/node_modules
	rm -rf __pycache__ */__pycache__ */*/__pycache__
	rm -rf .pytest_cache tests/.pytest_cache
	rm -rf *.egg-info
	rm -rf .ruff_cache
	@echo "âœ… Clean complete!"

clean-all: clean
	@echo "ğŸ§¹ Deep cleaning..."
	rm -rf .venv
	rm -rf web/dist
	rm -rf dist/

# ============================================
# å¼€å‘å·¥ä½œæµ
# ============================================

dev-setup: install-dev install-vue build-vue
	@echo "âœ… Development environment ready!"

dev-vue:
	@echo "ğŸ”„ Starting Vue dev server..."
	cd web && npm run dev

standalone:
	@echo "ğŸš€ Starting standalone Flask server..."
	@echo "   è®¿é—® http://127.0.0.1:5000/standalone/ è¿›è¡Œæµ‹è¯•"
	@echo ""
	COMFYUI_PROMPT_SKILLS_TESTING=1 python -c "from backend.logic import create_app, socketio; app = create_app(debug=True); socketio.run(app, host='127.0.0.1', port=5000, allow_unsafe_werkzeug=True)"

debug:
	@echo "ğŸ”§ Starting Flask server in DEBUG mode..."
	@echo "   ç¯å¢ƒå˜é‡ COMFYUI_PROMPT_SKILLS_DEBUG=1 å·²å¯ç”¨"
	@echo "   è®¿é—® http://127.0.0.1:5000/standalone/ è¿›è¡Œæµ‹è¯•"
	@echo ""
	COMFYUI_PROMPT_SKILLS_TESTING=1 COMFYUI_PROMPT_SKILLS_DEBUG=1 python -c "from backend.logic import create_app, socketio; app = create_app(debug=True); socketio.run(app, host='127.0.0.1', port=5000, allow_unsafe_werkzeug=True)"

# ============================================
# å®Œæ•´æµç¨‹
# ============================================

all: install-dev install-vue build test
	@echo ""
	@echo "ğŸ‰ All done! Ready to use in ComfyUI."
