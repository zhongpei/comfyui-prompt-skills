<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Skills - Standalone Testing</title>
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #e8e8e8;
            --text-secondary: #aaa;
            --accent-blue: #61dafb;
            --accent-green: #4ade80;
            --accent-yellow: #fbbf24;
            --accent-red: #f87171;
            --border-color: #2a2a4a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--accent-blue);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .status-idle {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }

        .status-working {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }

        .status-error {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }

        .status-disconnected {
            background: rgba(170, 170, 170, 0.2);
            color: var(--text-secondary);
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--accent-blue);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Skills Panel */
        .skill-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .skill-item:hover {
            border-color: var(--accent-blue);
        }

        .skill-item.selected {
            border-color: var(--accent-green);
            background: rgba(74, 222, 128, 0.1);
        }

        .skill-name {
            font-weight: 600;
        }

        .skill-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Chat Panel */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }

        .message-user {
            background: var(--bg-tertiary);
            margin-left: 2rem;
        }

        .message-assistant {
            background: rgba(97, 218, 251, 0.1);
            border: 1px solid rgba(97, 218, 251, 0.2);
            margin-right: 2rem;
        }

        .message-role {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .streaming-cursor {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .input-area {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
        }

        .input-area textarea {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: inherit;
            resize: none;
        }

        .input-area textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .input-area button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-send {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .btn-send:hover {
            filter: brightness(1.1);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-abort {
            background: var(--accent-red);
            color: white;
        }

        /* Debug Panel */
        .debug-entry {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            background: var(--bg-primary);
        }

        .debug-INFO {
            border-left: 3px solid var(--accent-green);
        }

        .debug-DEBUG {
            border-left: 3px solid var(--accent-blue);
        }

        .debug-WARN {
            border-left: 3px solid var(--accent-yellow);
        }

        .debug-ERROR {
            border-left: 3px solid var(--accent-red);
        }

        .debug-level {
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .debug-module {
            color: var(--accent-yellow);
            margin-right: 0.5rem;
        }

        .debug-message {
            color: var(--text-secondary);
        }

        /* Output Panel */
        .output-tabs {
            display: flex;
            padding: 0.5rem;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .output-tabs button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .output-tabs button.active {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-color: var(--accent-blue);
        }

        .output-content pre {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.85rem;
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            font-style: italic;
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ¨ Prompt Skills - Standalone Testing</h1>
        <div>
            <span id="session-id" style="font-size: 0.8rem; color: var(--text-secondary); margin-right: 1rem;">Session:
                -</span>
            <span id="status-badge" class="status-badge status-disconnected">Disconnected</span>
        </div>
    </header>

    <main>
        <!-- Skills Panel -->
        <div class="panel">
            <div class="panel-header">ğŸ¯ æŠ€èƒ½é€‰æ‹©</div>
            <div class="panel-content" id="skills-list">
                <div class="empty-state">æ­£åœ¨åŠ è½½æŠ€èƒ½...</div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="panel" style="display: flex; flex-direction: column;">
            <div class="panel-header">ğŸ’¬ å¯¹è¯</div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <textarea id="input" rows="3" placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾åƒ..."></textarea>
                <button id="send-btn" class="btn-send">å‘é€</button>
            </div>
        </div>

        <!-- Debug & Output Panel -->
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Debug Panel -->
            <div class="panel" style="flex: 1;">
                <div class="panel-header">ğŸ”§ è°ƒè¯•æ—¥å¿—</div>
                <div class="panel-content" id="debug-logs">
                    <div class="empty-state">ç­‰å¾…è¿æ¥...</div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="panel" style="flex: 1;">
                <div class="panel-header">ğŸ“ è¾“å‡º</div>
                <div class="output-tabs">
                    <button class="active" data-tab="english">English</button>
                    <button data-tab="json">JSON</button>
                    <button data-tab="bilingual">Bilingual</button>
                </div>
                <div class="panel-content" id="output-content">
                    <div class="empty-state">ç­‰å¾…ç”Ÿæˆ...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // State
        let socket = null;
        let sessionId = 'standalone_' + Math.random().toString(36).substring(2, 10);
        let selectedSkills = [];
        let messages = [];
        let debugLogs = [];
        let lastOutput = null;
        let activeTab = 'english';
        let streamingText = '';
        let status = 'disconnected';

        // DOM Elements
        const statusBadge = document.getElementById('status-badge');
        const sessionIdEl = document.getElementById('session-id');
        const skillsList = document.getElementById('skills-list');
        const messagesEl = document.getElementById('messages');
        const debugLogsEl = document.getElementById('debug-logs');
        const outputContent = document.getElementById('output-content');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send-btn');

        // Update UI functions
        function updateStatus(newStatus) {
            status = newStatus;
            statusBadge.className = 'status-badge status-' + status;
            statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            sendBtn.disabled = status === 'working';
        }

        function renderSkills(skills) {
            if (!skills.length) {
                skillsList.innerHTML = '<div class="empty-state">æš‚æ— å¯ç”¨æŠ€èƒ½</div>';
                return;
            }
            skillsList.innerHTML = skills.map(skill => `
                <div class="skill-item ${selectedSkills.includes(skill.id) ? 'selected' : ''}" 
                     data-skill-id="${skill.id}">
                    <div class="skill-name">${skill.name_zh || skill.name}</div>
                    <div class="skill-desc">${skill.description || skill.id}</div>
                </div>
            `).join('');

            // Add click handlers
            skillsList.querySelectorAll('.skill-item').forEach(el => {
                el.addEventListener('click', () => {
                    const skillId = el.dataset.skillId;
                    const idx = selectedSkills.indexOf(skillId);
                    if (idx >= 0) {
                        selectedSkills.splice(idx, 1);
                    } else {
                        selectedSkills.push(skillId);
                    }
                    el.classList.toggle('selected');

                    // Send configure event
                    if (socket) {
                        socket.emit('configure', {
                            session_id: sessionId,
                            active_skills: selectedSkills
                        });
                    }
                });
            });
        }

        function renderMessages() {
            if (!messages.length && !streamingText) {
                messagesEl.innerHTML = '<div class="empty-state">å¼€å§‹å¯¹è¯...</div>';
                return;
            }

            let html = messages.map(msg => `
                <div class="message message-${msg.role}">
                    <div class="message-role">${msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– åŠ©æ‰‹'}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');

            if (streamingText) {
                html += `
                    <div class="message message-assistant">
                        <div class="message-role">ğŸ¤– åŠ©æ‰‹</div>
                        <div class="message-content">${escapeHtml(streamingText)}<span class="streaming-cursor">â–Œ</span></div>
                    </div>
                `;
            }

            messagesEl.innerHTML = html;
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addDebugLog(log) {
            debugLogs.push(log);
            if (debugLogs.length > 100) debugLogs.shift();

            debugLogsEl.innerHTML = debugLogs.map(log => `
                <div class="debug-entry debug-${log.level}">
                    <span class="debug-level">[${log.level}]</span>
                    <span class="debug-module">${log.module}:</span>
                    <span class="debug-message">${escapeHtml(log.message)}</span>
                </div>
            `).join('');

            debugLogsEl.scrollTop = debugLogsEl.scrollHeight;
        }

        function renderOutput() {
            if (!lastOutput) {
                outputContent.innerHTML = '<div class="empty-state">ç­‰å¾…ç”Ÿæˆ...</div>';
                return;
            }

            const content = activeTab === 'english' ? lastOutput.prompt_english :
                activeTab === 'json' ? lastOutput.prompt_json :
                    lastOutput.prompt_bilingual;

            outputContent.innerHTML = `<pre>${escapeHtml(content || '(empty)')}</pre>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Socket connection
        function connect() {
            addDebugLog({ level: 'INFO', module: 'Client', message: 'Connecting to server...' });

            socket = io('http://127.0.0.1:8189', {
                query: { session_id: sessionId },
                transports: ['websocket'],
                reconnection: true,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                addDebugLog({ level: 'INFO', module: 'Client', message: 'Connected!' });
                updateStatus('idle');
                sessionIdEl.textContent = 'Session: ' + sessionId;
            });

            socket.on('disconnect', () => {
                addDebugLog({ level: 'WARN', module: 'Client', message: 'Disconnected' });
                updateStatus('disconnected');
            });

            socket.on('sync_state', (data) => {
                addDebugLog({ level: 'DEBUG', module: 'Client', message: 'State synced: ' + JSON.stringify(data).slice(0, 100) });
                messages = data.history || [];
                if (data.skills) selectedSkills = data.skills;
                updateStatus(data.status || 'idle');
                renderMessages();
            });

            socket.on('skills_list', (data) => {
                addDebugLog({ level: 'INFO', module: 'Client', message: `Received ${data.skills.length} skills` });
                renderSkills(data.skills);
            });

            socket.on('debug_log', (data) => {
                addDebugLog(data);
            });

            socket.on('stream_delta', (data) => {
                streamingText += data.delta;
                renderMessages();
            });

            socket.on('status_update', (data) => {
                updateStatus(data.status);
            });

            socket.on('complete', (data) => {
                lastOutput = data;
                streamingText = '';
                messages.push({
                    role: 'assistant',
                    content: data.prompt_english
                });
                renderMessages();
                renderOutput();
            });

            socket.on('error', (data) => {
                addDebugLog({ level: 'ERROR', module: 'Server', message: data.message });
            });
        }

        // Event handlers
        function sendMessage() {
            const content = inputEl.value.trim();
            if (!content || status === 'working') return;

            messages.push({ role: 'user', content });
            streamingText = '';
            inputEl.value = '';
            renderMessages();

            socket.emit('user_message', {
                session_id: sessionId,
                content: content,
                model_target: 'z-image-turbo'
            });
        }

        sendBtn.addEventListener('click', sendMessage);
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Tab switching
        document.querySelectorAll('.output-tabs button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.output-tabs button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeTab = btn.dataset.tab;
                renderOutput();
            });
        });

        // Initialize
        connect();
    </script>
</body>

</html>